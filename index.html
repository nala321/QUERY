<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Query-Tracker</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700&family=Ubuntu:wght@300;400;500;700&display=swap" rel="stylesheet">
<style>
/* ═══════════════════════════════════════════ TOKENS */
:root{
  --ff-h:'Quicksand',sans-serif;
  --ff-b:'Ubuntu',sans-serif;
  --bg:#edf1f7;--bg2:#e3eaf4;
  --surf:#fff;--surf2:#f5f8fc;--surf3:#edf1f8;
  --bd:#dae0eb;--bd2:#c4cedf;
  --tx:#0d1b2e;--tx2:#3a4f68;--mu:#7a8ea6;
  --ac:#2563eb;--acl:#3b82f6;
  --acg:linear-gradient(135deg,#3b82f6,#2563eb);
  --acs:0 6px 20px rgba(37,99,235,.26);
  --dg:#ef4444;--su:#10b981;--wa:#f59e0b;
  --r8:8px;--r12:12px;--r16:16px;--r20:20px;--rpill:999px;
  --s1:0 1px 4px rgba(13,27,46,.06),0 0 0 1px rgba(13,27,46,.04);
  --s2:0 4px 16px rgba(13,27,46,.08),0 1px 4px rgba(13,27,46,.04);
  --s3:0 14px 44px rgba(13,27,46,.13),0 2px 8px rgba(13,27,46,.06);
  --d:200ms;--dl:340ms;
  --e:cubic-bezier(.4,0,.2,1);
  --eo:cubic-bezier(0,0,.2,1);
  --es:cubic-bezier(.34,1.56,.64,1);
  --spb:#fffbeb;--spt:#92400e;
  --scb:#eff6ff;--sct:#1e40af;
  --skb:#f0fdf4;--skt:#166534;
  --sdb:#f8fafc;--sdt:#374151;
}
[data-theme=dark]{
  /* TRUE BLACK dark theme */
  --bg:#0a0a0a;--bg2:#111111;
  --surf:#141414;--surf2:#1c1c1c;--surf3:#212121;
  --bd:#2a2a2a;--bd2:#383838;
  --tx:#f0f0f0;--tx2:#aaaaaa;--mu:#666666;
  --ac:#4d9fff;--acl:#6bb3ff;
  --acg:linear-gradient(135deg,#3b82f6,#1d4ed8);
  --acs:0 6px 20px rgba(77,159,255,.22);
  --s1:0 1px 4px rgba(0,0,0,.5),0 0 0 1px rgba(255,255,255,.04);
  --s2:0 4px 20px rgba(0,0,0,.55),0 1px 4px rgba(0,0,0,.3);
  --s3:0 16px 50px rgba(0,0,0,.7),0 4px 12px rgba(0,0,0,.4);
  --spb:#2a1a00;--spt:#fbbf24;
  --scb:#0f1f3d;--sct:#93c5fd;
  --skb:#001a0d;--skt:#4ade80;
  --sdb:#1a1a1a;--sdt:#aaaaaa;
}
/* ═══════════════════════════════════════════ RESET */
*{box-sizing:border-box;margin:0;padding:0}
html{scroll-behavior:smooth}
body{font-family:var(--ff-b);background:var(--bg);color:var(--tx);min-height:100vh;transition:background var(--dl) var(--e),color var(--dl) var(--e);-webkit-font-smoothing:antialiased}
.H{font-family:var(--ff-h)}
.hidden{display:none!important}
button,input,select,textarea{font-family:var(--ff-b)}

/* ═══════════════════════════════════════════ FORMS */
input,select,textarea{width:100%;padding:9px 13px;border:1.5px solid var(--bd);border-radius:var(--r12);background:var(--surf2);color:var(--tx);font-size:13px;transition:border-color var(--d) var(--e),box-shadow var(--d) var(--e),background var(--d) var(--e);outline:none;line-height:1.5}
input::placeholder,textarea::placeholder{color:var(--mu)}
input:hover,select:hover,textarea:hover{border-color:var(--bd2)}
input:focus,select:focus,textarea:focus{border-color:var(--ac);background:var(--surf);box-shadow:0 0 0 3px rgba(37,99,235,.1)}
input[type=date]{cursor:pointer}
select{appearance:none;-webkit-appearance:none;padding-right:36px;cursor:pointer;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='15' height='15' fill='none' stroke='%237a8ea6' stroke-width='1.8' stroke-linecap='round' stroke-linejoin='round' viewBox='0 0 24 24'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E");
  background-repeat:no-repeat;background-position:right 10px center}
/* Auto-grow textarea */
textarea{resize:none;overflow:hidden;min-height:48px}
.fl{font-family:var(--ff-h);font-size:10px;font-weight:700;color:var(--mu);text-transform:uppercase;letter-spacing:.65px;margin-bottom:5px;display:block}
.fl-row{display:flex;align-items:center;gap:6px;margin-bottom:5px}
.fl-row .fl{margin-bottom:0}

/* ═══════════════════════════════════════════ BUTTONS */
.btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;padding:9px 18px;border-radius:var(--r12);border:none;cursor:pointer;font-family:var(--ff-h);font-size:12.5px;font-weight:700;white-space:nowrap;position:relative;overflow:hidden;transition:transform var(--d) var(--es),box-shadow var(--d) var(--e),background var(--d) var(--e)}
.btn::after{content:'';position:absolute;inset:0;border-radius:inherit;background:rgba(255,255,255,0);transition:background var(--d) var(--e)}
.btn:hover::after{background:rgba(255,255,255,.07)}
.btn:active{transform:scale(.97)!important}
.btn-p{background:var(--acg);color:#fff;box-shadow:var(--acs)}
.btn-p:hover{transform:translateY(-1px);box-shadow:0 8px 28px rgba(37,99,235,.35)}
.btn-g{background:var(--surf);color:var(--tx2);border:1.5px solid var(--bd);box-shadow:var(--s1)}
.btn-g:hover{transform:translateY(-1px);border-color:var(--bd2);box-shadow:var(--s2);color:var(--tx)}
.btn-sm{padding:6px 13px;font-size:11.5px;border-radius:var(--r8)}
/* icon button */
.ib{width:28px;height:28px;border-radius:50%;border:1.5px solid var(--bd);background:var(--surf2);color:var(--mu);cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;padding:0;transition:transform var(--d) var(--es),background var(--d) var(--e),border-color var(--d) var(--e),box-shadow var(--d) var(--e),color var(--d) var(--e)}
.ib:hover{transform:scale(1.12);box-shadow:var(--s1)}
.ib.chk:hover{background:var(--skb);color:var(--skt);border-color:var(--su)}
.ib.rec:hover{background:var(--acg);color:#fff;border-color:var(--ac);box-shadow:var(--acs)}
.ib.del{border-color:#fca5a5;color:#f87171}
.ib.del:hover{background:var(--dg);color:#fff;border-color:var(--dg);box-shadow:0 4px 12px rgba(239,68,68,.25)}

/* ═══════════════════════════════════════════ LAYOUT */
.wrap{max-width:1300px;margin:0 auto;padding:22px 26px;width:100%}

/* ═══════════════════════════════════════════ HEADER */
.hdr{display:flex;justify-content:space-between;align-items:center;padding:14px 20px;margin-bottom:18px;background:var(--surf);border-radius:var(--r20);border:1.5px solid var(--bd);box-shadow:var(--s1)}
.hdr-brand{display:flex;align-items:center;gap:11px}
.hdr-logo{width:34px;height:34px;background:var(--acg);border-radius:9px;display:flex;align-items:center;justify-content:center;box-shadow:var(--acs);flex-shrink:0}
.hdr-title{font-family:var(--ff-h);font-size:16px;font-weight:700;line-height:1}
.hdr-acts{display:flex;align-items:center;gap:7px}
.th-sel{background-image:none!important;padding:7px 12px;width:auto;font-size:11px;font-weight:600;font-family:var(--ff-h);border-radius:var(--r12);cursor:pointer;border:1.5px solid var(--bd);background:var(--surf2)!important;color:var(--tx2);transition:border-color var(--d) var(--e),color var(--d) var(--e)}
.th-sel:hover{border-color:var(--bd2);color:var(--tx)}

/* ═══════════════════════════════════════════ TABS */
.tabbar{display:inline-flex;gap:3px;background:var(--surf);border:1.5px solid var(--bd);border-radius:var(--r16);padding:3px;box-shadow:var(--s1);margin-bottom:16px}
.tabi{padding:7px 18px;border-radius:var(--r12);font-family:var(--ff-h);font-size:12.5px;font-weight:700;color:var(--mu);cursor:pointer;border:1.5px solid transparent;display:flex;align-items:center;gap:6px;transition:background var(--d) var(--e),color var(--d) var(--e),border-color var(--d) var(--e),box-shadow var(--d) var(--e)}
.tabi:hover:not(.on){background:var(--surf3);color:var(--tx2)}
.tabi.on{background:var(--surf3);color:var(--tx);border-color:var(--bd);box-shadow:var(--s1)}
.tabi.on svg{color:var(--ac)}

/* ═══════════════════════════════════════════ FILTER + SEARCH BAR */
.filterbar{display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap;align-items:center}
.filterbar input{min-width:200px;flex:2}
.filterbar select{width:auto;min-width:160px;flex:1}
.filterbar .btn{flex-shrink:0}
.filter-chip{display:inline-flex;align-items:center;gap:5px;padding:4px 10px;border-radius:var(--rpill);background:var(--surf3);border:1.5px solid var(--bd2);font-family:var(--ff-h);font-size:11px;font-weight:700;color:var(--tx2)}
.filter-chip button{background:none;border:none;cursor:pointer;color:var(--mu);padding:0;width:14px;height:14px;display:flex;align-items:center;justify-content:center;border-radius:50%;transition:color var(--d) var(--e),background var(--d) var(--e)}
.filter-chip button:hover{color:var(--dg);background:rgba(239,68,68,.1)}

/* ═══════════════════════════════════════════ CLAIMS */
.clist{display:flex;flex-direction:column;gap:8px}

/* Card */
.cc{background:var(--surf);border:1.5px solid var(--bd);border-radius:var(--r20);box-shadow:var(--s1);overflow:hidden;transition:border-color var(--d) var(--e),box-shadow var(--d) var(--e)}
.cc:hover{border-color:var(--acl);box-shadow:var(--s2)}

/* Summary row */
.ccrow{display:grid;grid-template-columns:190px 1fr auto;align-items:stretch;cursor:pointer;user-select:none;transition:background var(--d) var(--e)}
.cc:hover .ccrow{background:var(--surf3)}
.ccL{display:flex;flex-direction:column;justify-content:center;padding:13px 16px;border-right:1.5px solid var(--bd);gap:3px;min-width:0}
.ccM{display:flex;align-items:center;flex-wrap:wrap;gap:14px;padding:11px 18px;flex:1;min-width:0}
.ccR{display:flex;align-items:center;gap:7px;padding:11px 14px;border-left:1.5px solid var(--bd);flex-shrink:0}
.cc-id{font-family:var(--ff-h);font-size:14.5px;font-weight:700;color:var(--ac);white-space:nowrap}
.cc-ins{font-family:var(--ff-h);font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.7px;color:var(--mu);margin-top:1px}
.chip{display:flex;flex-direction:column;gap:1px;min-width:0}
.chip-l{font-family:var(--ff-h);font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--mu)}
.chip-v{font-size:12.5px;font-weight:500;color:var(--tx);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:180px}
.pills{display:flex;gap:5px;flex-wrap:wrap;align-items:center}
.pill{padding:2px 8px;border-radius:var(--rpill);font-family:var(--ff-h);font-size:10.5px;font-weight:700;background:var(--surf3);border:1.5px solid var(--bd);color:var(--mu);white-space:nowrap;cursor:default}
.pill-g{background:#f0fdf4;border-color:#bbf7d0;color:#15803d}
.pill-b{background:#eff6ff;border-color:#bfdbfe;color:#1d4ed8}
.pill-link{cursor:pointer;transition:background var(--d) var(--e),border-color var(--d) var(--e)}
.pill-link:hover{border-color:var(--acl);background:rgba(37,99,235,.07);color:var(--ac)}
[data-theme=dark] .pill-g{background:#001a0d;border-color:#166534;color:#4ade80}
[data-theme=dark] .pill-b{background:#0f1f3d;border-color:#1e40af;color:#93c5fd}

/* Status select pill */
.spill{padding:5px 22px 5px 10px;border-radius:var(--rpill);font-family:var(--ff-h);font-size:10.5px;font-weight:700;border:none;outline:none;cursor:pointer;min-width:130px;appearance:none;-webkit-appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='11' height='11' fill='none' stroke='%237a8ea6' stroke-width='2.2' stroke-linecap='round' stroke-linejoin='round' viewBox='0 0 24 24'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 7px center;transition:box-shadow var(--d) var(--e),transform var(--d) var(--es)}
.spill:hover{box-shadow:0 2px 8px rgba(0,0,0,.15);transform:translateY(-1px)}

/* Chevron */
.chevron{width:24px;height:24px;border-radius:50%;background:var(--surf3);border:1.5px solid var(--bd);display:flex;align-items:center;justify-content:center;flex-shrink:0;pointer-events:none;transition:transform var(--dl) var(--e),background var(--d) var(--e),border-color var(--d) var(--e)}
.cc.open .chevron{transform:rotate(180deg);background:var(--ac);border-color:var(--ac)}
.cc.open .chevron svg{color:#fff!important}

/* ═══════════════════════════════════════════ EXPAND PANEL */
.ccp{display:grid;grid-template-rows:0fr;transition:grid-template-rows var(--dl) var(--eo)}
.cc.open .ccp{grid-template-rows:1fr}
.ccp-inner{overflow:hidden}
.ccp-body{border-top:1.5px solid var(--bd);background:var(--surf3)}

/* Two-column layout inside expand */
.exp-layout{display:grid;grid-template-columns:1fr 340px;gap:0;min-height:0}
.exp-main{padding:16px;display:flex;flex-direction:column;gap:12px;border-right:1.5px solid var(--bd)}
.exp-side{padding:16px;display:flex;flex-direction:column;gap:12px;background:var(--surf2)}

/* Section box */
.psec{background:var(--surf);border:1.5px solid var(--bd);border-radius:var(--r16);overflow:hidden}
.psec-hd{display:flex;align-items:center;gap:8px;padding:10px 13px;border-bottom:1.5px solid var(--bd);background:var(--surf2)}
.psec-ico{width:22px;height:22px;border-radius:6px;background:var(--surf3);border:1.5px solid var(--bd);display:flex;align-items:center;justify-content:center;flex-shrink:0}
.psec-t{font-family:var(--ff-h);font-size:11px;font-weight:700;color:var(--tx2);flex:1}
.psec-c{font-family:var(--ff-h);font-size:10.5px;font-weight:700;color:var(--mu);background:var(--surf3);border:1.5px solid var(--bd);border-radius:var(--rpill);padding:1px 8px}
.psec-bd{padding:13px}

/* Summary identity card at top of expand */
.id-card{background:var(--surf);border:1.5px solid var(--bd);border-radius:var(--r16);padding:14px 16px;display:flex;gap:16px;align-items:flex-start}
.id-card-icon{width:40px;height:40px;border-radius:var(--r12);background:var(--acg);display:flex;align-items:center;justify-content:center;flex-shrink:0;box-shadow:var(--acs)}
.id-card-body{flex:1;min-width:0}
.id-name{font-family:var(--ff-h);font-size:16px;font-weight:700;color:var(--tx);line-height:1.2;margin-bottom:4px}
.id-meta{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-top:6px}
.id-tag{font-family:var(--ff-h);font-size:11px;font-weight:700;padding:3px 10px;border-radius:var(--rpill);background:var(--surf3);border:1.5px solid var(--bd);color:var(--tx2);display:flex;align-items:center;gap:5px}
.id-tag svg{flex-shrink:0}

/* Field grids */
.fg4{display:grid;grid-template-columns:repeat(4,1fr);gap:9px}
.fg3{display:grid;grid-template-columns:repeat(3,1fr);gap:9px}
.fg2{display:grid;grid-template-columns:repeat(2,1fr);gap:9px}
.fgfc{grid-column:1/-1}

/* Request items */
.rlist{display:flex;flex-direction:column;gap:8px}
.ri{background:var(--surf2);border:1.5px solid var(--bd);border-radius:var(--r12);padding:11px;transition:border-color var(--d) var(--e),box-shadow var(--d) var(--e)}
.ri:hover{border-color:var(--bd2);box-shadow:var(--s1)}
.ri-top{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:7px}
.ri-meta{display:flex;align-items:center;gap:7px;flex:1;min-width:0}
.ri-by{font-family:var(--ff-h);font-size:11px;font-weight:700;color:var(--mu);background:transparent;border:1.5px dashed transparent;border-radius:6px;padding:2px 5px;cursor:text;outline:none;box-shadow:none;width:auto;max-width:180px;text-transform:uppercase;letter-spacing:.4px;transition:border-color var(--d) var(--e),background var(--d) var(--e),color var(--d) var(--e)}
.ri-by::placeholder{font-style:italic;text-transform:none}
.ri-by:hover{border-color:var(--bd2);background:var(--surf3);color:var(--tx2)}
.ri-by:focus{border-color:var(--ac);background:var(--surf);color:var(--tx);box-shadow:0 0 0 3px rgba(37,99,235,.09)}
.ri-date{font-family:var(--ff-h);font-size:10px;font-weight:600;color:var(--mu);background:var(--surf3);border:1.5px solid var(--bd);border-radius:var(--rpill);padding:1px 7px;white-space:nowrap}
.ri-ta{font-size:13px;border:none;background:transparent;padding:0;resize:none;box-shadow:none;color:var(--tx);line-height:1.6;width:100%;overflow:hidden}
.ri-ta:hover,.ri-ta:focus{border:none;box-shadow:none;background:transparent}

/* ═══════════════════════════════════════════ FILE ATTACHMENTS */
.file-drop-zone{border:2px dashed var(--bd);border-radius:var(--r12);padding:12px 14px;background:var(--surf3);transition:border-color var(--d) var(--e),background var(--d) var(--e);cursor:pointer;text-align:center;min-height:56px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:5px}
.file-drop-zone:hover,.file-drop-zone.drag{border-color:var(--ac);background:rgba(37,99,235,.04)}
.file-drop-zone p{font-family:var(--ff-h);font-size:11.5px;font-weight:600;color:var(--mu)}
.file-drop-zone span{font-size:11px;color:var(--mu);opacity:.7}
.file-list{display:flex;flex-direction:column;gap:6px;margin-top:8px}
.file-item{display:flex;align-items:center;gap:8px;padding:7px 10px;background:var(--surf);border:1.5px solid var(--bd);border-radius:var(--r8);transition:border-color var(--d) var(--e)}
.file-item:hover{border-color:var(--bd2)}
.file-icon{width:28px;height:28px;border-radius:7px;background:var(--surf3);border:1.5px solid var(--bd);display:flex;align-items:center;justify-content:center;flex-shrink:0}
.file-name{font-family:var(--ff-h);font-size:11.5px;font-weight:600;color:var(--tx2);flex:1;min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.file-open{font-family:var(--ff-h);font-size:10.5px;font-weight:700;color:var(--ac);cursor:pointer;background:none;border:none;padding:3px 8px;border-radius:6px;transition:background var(--d) var(--e);white-space:nowrap}
.file-open:hover{background:rgba(37,99,235,.08)}
.file-del{color:var(--mu);cursor:pointer;background:none;border:none;padding:3px;border-radius:50%;display:flex;align-items:center;justify-content:center;transition:color var(--d) var(--e),background var(--d) var(--e)}
.file-del:hover{color:var(--dg);background:rgba(239,68,68,.08)}
.file-path{font-size:10px;color:var(--mu);opacity:.65;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:100%;display:block;margin-top:1px}
.no-open-note{font-size:10.5px;color:var(--mu);text-align:center;line-height:1.5;padding:4px 0}

/* ═══════════════════════════════════════════ NEW QUERY DRAWER */
.nq-overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);backdrop-filter:blur(4px);z-index:6000;opacity:0;pointer-events:none;transition:opacity var(--dl) var(--e)}
.nq-overlay.open{opacity:1;pointer-events:all}
.nq-drawer{position:fixed;top:0;right:0;height:100%;width:min(560px,94vw);background:var(--surf);border-left:1.5px solid var(--bd);box-shadow:var(--s3);z-index:6001;transform:translateX(100%);transition:transform var(--dl) var(--es);display:flex;flex-direction:column;overflow:hidden}
.nq-overlay.open .nq-drawer{transform:translateX(0)}
.nq-hd{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;border-bottom:1.5px solid var(--bd);background:var(--surf2);flex-shrink:0}
.nq-title{font-family:var(--ff-h);font-size:15px;font-weight:700}
.nq-close{width:28px;height:28px;border-radius:50%;background:var(--surf3);border:1.5px solid var(--bd);color:var(--mu);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background var(--d) var(--e),color var(--d) var(--e),transform var(--d) var(--es);padding:0}
.nq-close:hover{background:var(--bg2);color:var(--tx);transform:scale(1.1)}
.nq-mode-bar{display:flex;gap:5px;padding:12px 20px 10px;flex-shrink:0;border-bottom:1.5px solid var(--bd)}
.nq-mbtn{padding:6px 15px;border-radius:var(--r8);font-family:var(--ff-h);font-size:12px;font-weight:700;cursor:pointer;border:1.5px solid var(--bd);background:var(--surf3);color:var(--mu);transition:all var(--d) var(--es)}
.nq-mbtn.on{background:var(--acg);color:#fff;border-color:transparent;box-shadow:var(--acs);transform:translateY(-1px)}
.nq-mbtn:hover:not(.on){background:var(--surf2);color:var(--tx2);border-color:var(--bd2)}
.nq-body{flex:1;overflow-y:auto;padding:16px 20px;display:flex;flex-direction:column;gap:12px}
.nq-foot{padding:12px 20px;border-top:1.5px solid var(--bd);background:var(--surf2);display:flex;gap:8px;flex-shrink:0}

/* Paste zone */
.dz{border:2px dashed var(--bd);border-radius:var(--r16);padding:13px;background:var(--surf3);transition:border-color var(--d) var(--e),background var(--d) var(--e)}
.dz.drag{border-color:var(--ac);background:rgba(37,99,235,.04);box-shadow:0 0 0 3px rgba(37,99,235,.08)}
.dz textarea{border:none;background:transparent;box-shadow:none;padding:0;font-size:13px;resize:none;min-height:90px}
.dz textarea:hover,.dz textarea:focus{border:none;box-shadow:none;background:transparent}
.mgrid{display:grid;grid-template-columns:1fr 1fr;gap:9px}

/* ═══════════════════════════════════════════ MISSING INFO MODAL */
.mveil{position:fixed;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(5px);z-index:9000;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity var(--dl) var(--e)}
.mveil.open{opacity:1;pointer-events:all}
.mbox{background:var(--surf);border:1.5px solid var(--bd);border-radius:var(--r20);width:100%;max-width:620px;margin:24px;box-shadow:var(--s3);transform:translateY(16px) scale(.97);transition:transform var(--dl) var(--es);overflow:hidden}
.mveil.open .mbox{transform:translateY(0) scale(1)}
.mhd{display:flex;justify-content:space-between;align-items:flex-start;padding:16px 20px;border-bottom:1.5px solid var(--bd);background:var(--surf2)}
.mtt{font-family:var(--ff-h);font-size:15px;font-weight:700}
.mst{font-size:11.5px;color:var(--mu);margin-top:3px;line-height:1.5}
.mcl{width:26px;height:26px;border-radius:50%;background:var(--surf3);border:1.5px solid var(--bd);color:var(--mu);cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;padding:0;transition:background var(--d) var(--e),color var(--d) var(--e),transform var(--d) var(--es)}
.mcl:hover{background:var(--bg2);color:var(--tx);transform:scale(1.1)}
.mbdy{padding:18px 20px}
.mgr{display:grid;grid-template-columns:1fr 1fr;gap:11px}
.mfc{grid-column:1/-1}
.mft{display:flex;gap:8px;padding:13px 20px;border-top:1.5px solid var(--bd);background:var(--surf2)}
.ftag{font-family:var(--ff-h);font-size:9.5px;font-weight:700;padding:1px 6px;border-radius:var(--rpill)}
.ftag-r{background:var(--spb);color:var(--spt)}
.ftag-k{background:var(--skb);color:var(--skt)}
.ftag-o{background:var(--surf3);color:var(--mu);border:1.5px solid var(--bd)}
.inwarn{border-color:var(--wa)!important;box-shadow:0 0 0 3px rgba(245,158,11,.1)!important}

/* ═══════════════════════════════════════════ PRINT MODAL */
.pveil{position:fixed;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(5px);z-index:9000;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity var(--dl) var(--e)}
.pveil.open{opacity:1;pointer-events:all}
.pbox{background:var(--surf);border:1.5px solid var(--bd);border-radius:var(--r20);width:100%;max-width:440px;margin:24px;box-shadow:var(--s3);transform:translateY(16px) scale(.97);transition:transform var(--dl) var(--es);overflow:hidden}
.pveil.open .pbox{transform:translateY(0) scale(1)}
.phd{display:flex;justify-content:space-between;align-items:center;padding:16px 20px;border-bottom:1.5px solid var(--bd);background:var(--surf2)}
.pht{font-family:var(--ff-h);font-size:15px;font-weight:700}
.pbdy{padding:16px 20px;display:flex;flex-direction:column;gap:9px}
.popt{display:flex;align-items:center;gap:12px;padding:13px 14px;border:1.5px solid var(--bd);border-radius:var(--r16);cursor:pointer;transition:border-color var(--d) var(--e),background var(--d) var(--e),box-shadow var(--d) var(--e);background:var(--surf2)}
.popt:hover{border-color:var(--acl);background:var(--surf3);box-shadow:var(--s1)}
.popt-ico{width:38px;height:38px;background:var(--surf3);border:1.5px solid var(--bd);border-radius:var(--r12);display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:background var(--d) var(--e),border-color var(--d) var(--e)}
.popt:hover .popt-ico{background:var(--acg);border-color:var(--ac)}
.popt:hover .popt-ico svg{stroke:#fff}
.popt-t{font-family:var(--ff-h);font-size:13px;font-weight:700;color:var(--tx)}
.popt-s{font-size:11.5px;color:var(--mu);margin-top:2px}
.pft{padding:12px 20px;border-top:1.5px solid var(--bd);background:var(--surf2);display:flex;justify-content:flex-end}

/* ═══════════════════════════════════════════ LOGIN */
#lscr{position:fixed;inset:0;background:var(--bg);display:flex;align-items:center;justify-content:center;z-index:8000;transition:opacity var(--dl) var(--e)}
.lcard{width:100%;max-width:360px;margin:24px;background:var(--surf);border:1.5px solid var(--bd);border-radius:var(--r20);padding:32px;box-shadow:var(--s3)}
.llogo{width:48px;height:48px;background:var(--acg);border-radius:13px;margin:0 auto 16px;display:flex;align-items:center;justify-content:center;box-shadow:var(--acs)}
.ltit{font-family:var(--ff-h);font-size:20px;font-weight:700;text-align:center;margin-bottom:4px}
.lsub{font-size:12.5px;color:var(--mu);text-align:center;margin-bottom:22px}

/* ═══════════════════════════════════════════ TOAST */
#tdock{position:fixed;bottom:22px;left:50%;transform:translateX(-50%);z-index:9999;display:flex;flex-direction:column;gap:6px;pointer-events:none;align-items:center}
.toast{background:var(--surf);color:var(--tx);padding:9px 18px 9px 12px;border-radius:var(--rpill);box-shadow:var(--s3);font-family:var(--ff-h);font-size:12.5px;font-weight:600;border:1.5px solid var(--bd);display:flex;align-items:center;gap:8px;opacity:0;transform:translateY(8px) scale(.95);transition:opacity var(--d) var(--e),transform var(--d) var(--es);white-space:nowrap}
.toast.in{opacity:1;transform:translateY(0) scale(1)}
.tdot{width:7px;height:7px;border-radius:50%;flex-shrink:0}

/* ═══════════════════════════════════════════ LOADER */
#ldr{position:fixed;top:16px;right:16px;padding:7px 15px;background:var(--surf);border:1.5px solid var(--bd);border-radius:var(--rpill);font-family:var(--ff-h);font-size:11.5px;font-weight:600;box-shadow:var(--s2);color:var(--tx2);transform:translateY(-60px);opacity:0;transition:all var(--d) var(--e);z-index:9500;display:flex;align-items:center;gap:7px}
#ldr.on{transform:translateY(0);opacity:1}
.lspin{width:12px;height:12px;border-radius:50%;border:2px solid var(--bd);border-top-color:var(--ac);animation:spin .7s linear infinite;flex-shrink:0}
@keyframes spin{to{transform:rotate(360deg)}}

/* ═══════════════════════════════════════════ EMPTY */
.empty{text-align:center;padding:48px 24px;color:var(--mu);background:var(--surf);border:1.5px solid var(--bd);border-radius:var(--r20);box-shadow:var(--s1)}
.empty-ico{width:48px;height:48px;background:var(--surf3);border:1.5px solid var(--bd);border-radius:var(--r16);margin:0 auto 12px;display:flex;align-items:center;justify-content:center}
.empty-t{font-family:var(--ff-h);font-size:14px;font-weight:700;color:var(--tx2);margin-bottom:4px}

/* ═══════════════════════════════════════════ MOBILE BLOCK */
#mblk{display:none;position:fixed;inset:0;background:var(--bg);z-index:99999;align-items:center;justify-content:center;padding:24px}
@media(max-width:720px){#mblk{display:flex}#lscr,#app{display:none!important}}

/* ═══════════════════════════════════════════ PRINT */
@media print{
  *{-webkit-print-color-adjust:exact;print-color-adjust:exact}
  body{background:#fff!important;color:#000!important}
  #ldr,#tdock,#mblk,#lscr,#modal,#nq-overlay,#print-modal,.hdr,.tabbar,.filterbar{display:none!important}
  .wrap{padding:0!important;max-width:100%!important}
  .cc:not(.open){display:none!important}
  .ccp{display:block!important;grid-template-rows:unset!important}
  .ccp-inner{overflow:visible!important}
  .ccrow{cursor:default}
  .ccR .ib,.ccR .spill,.chevron{display:none!important}
  .clist{gap:0!important}
  .cc{border-radius:0!important;box-shadow:none!important;border:none!important;border-bottom:2pt solid #ddd!important;page-break-inside:avoid;margin-bottom:12pt}
  .ccp-body{background:#fff!important}
  .exp-layout{grid-template-columns:1fr!important}
  .exp-side{display:none!important}
  .psec{border-radius:4pt!important;border-color:#ccc!important}
  .psec-hd{background:#f5f5f5!important}
  input,textarea,.ri-ta{border-color:#ddd!important;background:#fafafa!important;color:#000!important;-webkit-text-fill-color:#000!important}
  .ri{background:#f9f9f9!important;border-color:#ddd!important}
  .id-card{border-color:#ddd!important}
  @page{margin:15mm;size:A4}
}

/* Ripple */
@keyframes ripple{0%{transform:scale(0);opacity:.4}100%{transform:scale(2.5);opacity:0}}
.rpling::before{content:'';position:absolute;inset:0;border-radius:inherit;background:rgba(255,255,255,.3);animation:ripple .5s var(--e) forwards}
</style>
</head>
<body>

<!-- Mobile block -->
<div id="mblk">
  <div style="background:var(--surf);border:1.5px solid var(--bd);border-radius:var(--r20);padding:32px;max-width:340px;box-shadow:var(--s3);text-align:center">
    <div style="width:44px;height:44px;background:var(--surf3);border:1.5px solid var(--bd);border-radius:var(--r16);margin:0 auto 12px;display:flex;align-items:center;justify-content:center">
      <svg width="19" height="19" viewBox="0 0 24 24" fill="none" stroke="var(--mu)" stroke-width="1.8"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
    </div>
    <h2 style="font-family:var(--ff-h);font-size:16px;font-weight:700;margin-bottom:6px">Desktop Required</h2>
    <p style="font-size:12px;color:var(--mu);line-height:1.6">Switch to a larger screen to access the full workspace.</p>
  </div>
</div>

<div id="ldr"><div class="lspin"></div>Syncing…</div>
<div id="tdock"></div>

<!-- Login -->
<div id="lscr">
  <div class="lcard">
    <div class="llogo">
      <svg width="19" height="19" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
    </div>
    <h1 class="ltit">Query Tracker</h1>
    <p class="lsub">Sign in to your workspace</p>
    <label class="fl">Username</label>
    <input id="lu" type="text" placeholder="Enter username" style="margin-bottom:10px">
    <label class="fl">PIN</label>
    <input id="lp" type="password" placeholder="Enter PIN" style="margin-bottom:18px" onkeydown="if(event.key==='Enter')doLogin()">
    <button class="btn btn-p" style="width:100%;padding:11px" onclick="doLogin()">Sign In</button>
    <p id="lerr" style="font-family:var(--ff-h);color:var(--dg);font-size:11.5px;text-align:center;margin-top:10px;min-height:14px;font-weight:600"></p>
  </div>
</div>

<!-- Missing info modal -->
<div id="modal" class="mveil">
  <div class="mbox">
    <div class="mhd">
      <div>
        <div class="mtt">Complete Missing Information</div>
        <div class="mst">Fields marked <span class="ftag ftag-r">Required</span> must be filled before saving.</div>
      </div>
      <button class="mcl" onclick="closeModal()">
        <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div class="mbdy">
      <div class="mgr">
        <div class="mfc">
          <div class="fl-row"><span class="fl">Claim Number</span><span id="mt-cid" class="ftag ftag-o">Auto-generated</span></div>
          <input id="mf-cid" type="text" placeholder="Leave blank to auto-generate">
        </div>
        <div>
          <div class="fl-row"><span class="fl">Insurer</span><span class="ftag ftag-o">Optional</span></div>
          <input id="mf-ins" type="text" placeholder="e.g. AIA, Infinity">
        </div>
        <div>
          <div class="fl-row"><span class="fl">Insured Company</span><span class="ftag ftag-o">Optional</span></div>
          <input id="mf-ico" type="text" placeholder="Employer / group">
        </div>
        <div>
          <div class="fl-row"><span class="fl">Claimant — Patient</span><span id="mt-cus" class="ftag ftag-r">Required</span></div>
          <input id="mf-cus" type="text" placeholder="Full name of patient">
        </div>
        <div>
          <div class="fl-row"><span class="fl">Requested By</span><span class="ftag ftag-o">Optional</span></div>
          <input id="mf-rby" type="text" placeholder="Name of requester">
        </div>
        <div>
          <div class="fl-row"><span class="fl">Accident / Incident Date</span><span class="ftag ftag-o">Optional</span></div>
          <input id="mf-acd" type="date">
        </div>
        <div>
          <div class="fl-row"><span class="fl">Claim Amount (USD)</span><span class="ftag ftag-o">Optional</span></div>
          <input id="mf-amt" type="text" placeholder="e.g. 57.50">
        </div>
        <div class="mfc">
          <div class="fl-row"><span class="fl">Request Details</span><span id="mt-rtx" class="ftag ftag-r">Required</span></div>
          <textarea id="mf-rtx" rows="3" placeholder="What documents or info are being requested?"></textarea>
        </div>
      </div>
    </div>
    <div class="mft">
      <button class="btn btn-p" onclick="submitModal()" style="flex:1">Confirm &amp; Add Query</button>
      <button class="btn btn-g" onclick="closeModal()">Cancel</button>
    </div>
  </div>
</div>

<!-- Print modal -->
<div id="print-modal" class="pveil">
  <div class="pbox">
    <div class="phd">
      <span class="pht H">Print / Save Claim</span>
      <button class="mcl" onclick="closePrintModal()">
        <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div class="pbdy">
      <div class="popt" onclick="doPrint('portrait')">
        <div class="popt-ico"><svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="var(--ac)" stroke-width="2" stroke-linecap="round"><rect x="4" y="2" width="16" height="20" rx="2"/><line x1="8" y1="8" x2="16" y2="8"/><line x1="8" y1="12" x2="16" y2="12"/><line x1="8" y1="16" x2="12" y2="16"/></svg></div>
        <div><div class="popt-t">Portrait — A4</div><div class="popt-s">Vertical layout, standard</div></div>
      </div>
      <div class="popt" onclick="doPrint('landscape')">
        <div class="popt-ico"><svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="var(--ac)" stroke-width="2" stroke-linecap="round"><rect x="2" y="4" width="20" height="16" rx="2"/><line x1="6" y1="8" x2="18" y2="8"/><line x1="6" y1="12" x2="18" y2="12"/><line x1="6" y1="16" x2="14" y2="16"/></svg></div>
        <div><div class="popt-t">Landscape — A4</div><div class="popt-s">Wide layout, more field space</div></div>
      </div>
    </div>
    <div class="pft"><button class="btn btn-g btn-sm" onclick="closePrintModal()">Cancel</button></div>
  </div>
</div>

<!-- New Query Drawer -->
<div id="nq-overlay" class="nq-overlay" onclick="if(event.target===this)closeDrawer()">
  <div class="nq-drawer">
    <div class="nq-hd">
      <div class="nq-title H">Add New Query</div>
      <button class="nq-close" onclick="closeDrawer()">
        <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div class="nq-mode-bar">
      <button class="nq-mbtn on" id="nqm-paste" onclick="setNQMode('paste')">Paste Email</button>
      <button class="nq-mbtn" id="nqm-manual" onclick="setNQMode('manual')">Manual Entry</button>
    </div>
    <div id="nq-paste" class="nq-body">
      <p style="font-size:12px;color:var(--mu);line-height:1.6">Paste an copy from <strong style="color:var(--tx2)">Mail or Portal</strong> or <strong style="color:var(--tx2)">To Auto Fill</strong>.:D.</p>
      <div>
        <label class="fl">Email Notification Text</label>
        <div class="dz" id="drop-zone">
          <textarea id="email-input" rows="6" placeholder="Paste or drag email text here…"></textarea>
        </div>
      </div>
      <div style="display:flex;gap:8px;margin-top:4px">
        <button class="btn btn-p" onclick="processInput()">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          Add Query
        </button>
        <button class="btn btn-g btn-sm" onclick="document.getElementById('email-input').value=''">Clear</button>
      </div>
    </div>
    <div id="nq-manual" class="nq-body hidden">
      <div class="mgrid">
        <div><label class="fl">Claim Number</label><input id="m-cid" type="text" placeholder="Auto-generated if blank"></div>
        <div><label class="fl">Insurer</label><input id="m-ins" type="text" placeholder="e.g. AIA, Infinity"></div>
        <div><label class="fl">Insured Company</label><input id="m-ico" type="text" placeholder="Employer / group"></div>
        <div><label class="fl">Claimant — Patient</label><input id="m-cus" type="text" placeholder="Patient full name"></div>
        <div><label class="fl">Requested By <span style="color:var(--mu);font-size:9px">(optional)</span></label><input id="m-rby" type="text" placeholder="Requester name"></div>
        <div><label class="fl">Accident / Incident Date</label><input id="m-acd" type="date"></div>
        <div><label class="fl">Claim Amount (USD)</label><input id="m-amt" type="text" placeholder="e.g. 57.50"></div>
        <div><label class="fl">Request Details</label><input id="m-rtx" type="text" placeholder="What is being requested?"></div>
      </div>
      <div style="display:flex;gap:8px;margin-top:4px">
        <button class="btn btn-p" onclick="saveManual()">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          Save Query
        </button>
        <button class="btn btn-g btn-sm" onclick="setNQMode('paste')">Cancel</button>
      </div>
    </div>
  </div>
</div>

<!-- App -->
<div id="app" class="hidden">
<div class="wrap">

  <!-- Header -->
  <div class="hdr">
    <div class="hdr-brand">
      <div class="hdr-logo">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
      </div>
      <div class="hdr-title H">Query Tracker</div>
    </div>
    <div class="hdr-acts">
      <select class="th-sel" id="thsel" onchange="setTheme()">
        <option value="system">System Theme</option>
        <option value="light">Light</option>
        <option value="dark">Dark</option>
        <option value="auto">Auto (Time)</option>
      </select>
      <button class="btn btn-g btn-sm" onclick="exportCSV()">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
        Export CSV
      </button>
      <button class="btn btn-g btn-sm" onclick="syncData(true)">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 102.13-9.36L1 10"/></svg>
        Sync
      </button>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tabbar">
    <button class="tabi on" id="tab-active" onclick="switchTab('active')">
      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/></svg>
      Active Claims
    </button>
    <button class="tabi" id="tab-trash" onclick="switchTab('trash')">
      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a1 1 0 011-1h4a1 1 0 011 1v2"/></svg>
      Trash / Recovery
    </button>
  </div>

  <!-- Filter + Search + New Query bar -->
  <div class="filterbar">
    <input type="text" id="search" placeholder="Search claims, patients, handlers, phone…" oninput="renderClaims()">
    <select id="flt-inscomp" onchange="renderClaims()" title="Filter by Insured Company">
      <option value="">All Companies</option>
    </select>
    <select id="flt-insurer" onchange="renderClaims()" title="Filter by Insurer">
      <option value="">All Insurers</option>
    </select>
    <select id="sort" onchange="renderClaims()">
      <option value="desc">Newest First</option>
      <option value="asc">Oldest First</option>
      <option value="alpha">Alphabetical</option>
    </select>
    <button class="btn btn-p" id="nq-btn" onclick="openDrawer()">
      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
      New Query
    </button>
  </div>

  <!-- Claims list -->
  <div class="clist" id="clist"></div>

</div>
</div>

<!-- Hidden file input -->
<input type="file" id="file-picker" style="display:none" multiple>

<script>
const API="https://script.google.com/macros/s/AKfycbwgZyOi0TAyQwXV_j7jqOAi2K4eYq6dBDuv4hFVbST8uE9cXfc4XNohrNWZDEDpaIAa/exec";
let DB={claims:[],statuses:[]};
let TAB='active';
let PENDING=null;
let PRINT_ID=null;
// FILE_ATTACH_TARGET = {claimId, index} or null
let FILE_ATTACH_TARGET=null;

/* ══ BOOT ══ */
window.onload=()=>{
  applyTheme();
  try{const c=localStorage.getItem('qt_db');if(c)DB=JSON.parse(c);}catch{}
  if(localStorage.getItem('qt_auth')){
    const ls=document.getElementById('lscr');
    ls.style.opacity=0;
    setTimeout(()=>{ls.classList.add('hidden');bootApp();syncData();},300);
  }
};
function bootApp(){
  document.getElementById('app').classList.remove('hidden');
  renderClaims();
}

/* ══ API ══ */
async function apicall(p){
  setLdr(true);
  try{const r=await fetch(API,{method:'POST',mode:'cors',body:JSON.stringify(p)});const d=await r.json();setLdr(false);return d;}
  catch(e){setLdr(false);toast('Network error','err');return null;}
}
function setLdr(s){document.getElementById('ldr').classList.toggle('on',s);}

async function syncData(manual){
  const r=await apicall({action:'sync'});
  if(r&&r.success){DB.claims=r.claims;DB.statuses=r.statuses;save();renderClaims();}
  if(manual)toast(r&&r.success?'Synced successfully':'Sync failed',r&&r.success?'ok':'err');
}
async function persist(claim){save();renderClaims();await apicall({action:'saveClaim',claim});}
function save(){localStorage.setItem('qt_db',JSON.stringify(DB));}

/* ══ LOGIN ══ */
async function doLogin(){
  const u=document.getElementById('lu').value.trim(),p=document.getElementById('lp').value.trim(),e=document.getElementById('lerr');
  if(!u||!p){e.textContent='Credentials required.';return;}
  e.textContent='Authenticating…';
  const r=await apicall({action:'login',user:u,pin:p});
  if(r&&r.success){localStorage.setItem('qt_auth','1');localStorage.setItem('qt_user',u);window.location.reload();}
  else{e.textContent=r?r.error:'Connection failed.';}
}

/* ══ THEME ══ */
function setTheme(){localStorage.setItem('qt_theme',document.getElementById('thsel').value);applyTheme();}
function applyTheme(){
  const v=localStorage.getItem('qt_theme')||'system';
  const s=document.getElementById('thsel');if(s)s.value=v;
  const dark=v==='dark'||(v==='auto'&&(new Date().getHours()>=18||new Date().getHours()<6))||(v==='system'&&window.matchMedia('(prefers-color-scheme:dark)').matches);
  document.documentElement.setAttribute('data-theme',dark?'dark':'light');
}
window.matchMedia('(prefers-color-scheme:dark)').addEventListener('change',()=>{if((localStorage.getItem('qt_theme')||'system')==='system')applyTheme();});

/* ══ TABS ══ */
function switchTab(t){
  TAB=t;
  document.getElementById('tab-active').classList.toggle('on',t==='active');
  document.getElementById('tab-trash').classList.toggle('on',t==='trash');
  document.getElementById('nq-btn').style.display=t==='trash'?'none':'';
  renderClaims();
}

/* ══ DRAWER ══ */
function openDrawer(){document.getElementById('nq-overlay').classList.add('open');}
function closeDrawer(){document.getElementById('nq-overlay').classList.remove('open');}
function setNQMode(m){
  document.getElementById('nqm-paste').classList.toggle('on',m==='paste');
  document.getElementById('nqm-manual').classList.toggle('on',m==='manual');
  document.getElementById('nq-paste').classList.toggle('hidden',m!=='paste');
  document.getElementById('nq-manual').classList.toggle('hidden',m!=='manual');
}

/* ══ PRINT ══ */
function openPrintModal(id){PRINT_ID=id;document.getElementById('print-modal').classList.add('open');}
function closePrintModal(){document.getElementById('print-modal').classList.remove('open');}
function doPrint(orientation){
  closePrintModal();
  document.querySelectorAll('.cc.open').forEach(c=>{if(c.id!=='card-'+PRINT_ID)c.classList.remove('open');});
  const card=document.getElementById('card-'+PRINT_ID);
  if(card&&!card.classList.contains('open'))card.classList.add('open');
  let sty=document.getElementById('print-orient');
  if(!sty){sty=document.createElement('style');sty.id='print-orient';document.head.appendChild(sty);}
  sty.textContent=`@media print{@page{size:A4 ${orientation};margin:14mm}}`;
  setTimeout(()=>window.print(),120);
}

/* ══ FILTERS ══ */
function populateFilters(){
  const companies=[...new Set(DB.claims.map(c=>getRem(c.remark).inscomp||'').filter(Boolean))].sort();
  const insurers=[...new Set(DB.claims.map(c=>getRem(c.remark).insurer||'').filter(Boolean))].sort();
  const fc=document.getElementById('flt-inscomp');
  const fi=document.getElementById('flt-insurer');
  const cv=fc.value,iv=fi.value;
  fc.innerHTML='<option value="">All Companies</option>'+companies.map(c=>`<option value="${esc(c)}">${esc(c)}</option>`).join('');
  fi.innerHTML='<option value="">All Insurers</option>'+insurers.map(i=>`<option value="${esc(i)}">${esc(i)}</option>`).join('');
  fc.value=cv;fi.value=iv;
}

/* ══ PARSING ══ */
function genId(){return '2712_'+String(Math.floor(10000+Math.random()*90000));}
function processInput(){
  const txt=document.getElementById('email-input').value.trim();if(!txt)return;
  let p={claimid:'',insurer:'',inscomp:'',customer:'',reqby:'',reqtext:'',amount:'',accdate:'',datePasted:new Date().toISOString()};
  if(/Insura Portal|Comment by:|New Comment on Claim/i.test(txt)){
    p.insurer='Infinity';
    const cm=txt.match(/Claim\s+#([A-Z0-9]+)/i);if(cm)p.claimid=cm[1];
    const ic=txt.match(/Customer:\s*([^,\n]+)/i);if(ic)p.inscomp=ic[1].trim();
    const by=txt.match(/Comment by:\s*([^\n]+)/i);if(by)p.reqby=by[1].trim();
    const dt=txt.match(/Date:\s*([^\n]+)/i);if(dt){const d=new Date(dt[1].trim());if(!isNaN(d))p.datePasted=d.toISOString();}
    const rm=txt.match(/Date:[^\n]*\n([\s\S]*?)(?=View Claim Details|This notification)/i);if(rm)p.reqtext=rm[1].trim();
  } else if(/AIA BROKER|(Send Back By[\s\S]{0,30}Reimbursement)/i.test(txt)){
    p.insurer='AIA';
    const cm=txt.match(/Reimbursement\s*-\s*#([A-Z0-9]+)/i)||txt.match(/#([A-Z][A-Z0-9]{4,})/);if(cm)p.claimid=cm[1];
    const sb=txt.match(/Send Back By\s*\n([^\n]+)/i)||txt.match(/Send Back By\s+([^\n]+)/i);if(sb)p.reqby=sb[1].trim();
    const sd=txt.match(/Send Back Date\s*\n([^\n]+)/i)||txt.match(/Send Back Date\s+([^\n]+)/i);if(sd){const d=new Date(sd[1].trim());if(!isNaN(d))p.datePasted=d.toISOString();}
    const co=txt.match(/Comments on Need Information\s*\n([\s\S]*?)(?=សូមអរគុណ|See more|$)/i);
    if(co){let raw=co[1].trim();const bs=raw.search(/[:：]\s|\d+\//);p.reqtext=bs>0?raw.substring(bs).trim():raw;}
    const am=txt.match(/Total Claim Amount Submitted\s+[A-Z]+\s*([\d,.]+)/i)||txt.match(/USD\s*([\d,.]+)/i);if(am)p.amount=am[1];
  } else if(txt.includes('Send Back By')&&txt.includes('Comments on Need Information')){
    const cm=txt.match(/Claim\s+#([A-Z0-9]+)/i);if(cm)p.claimid=cm[1];
    const ic=txt.match(/Customer:\s*([^,\n]+)/i);if(ic)p.inscomp=ic[1].trim();
    const sb=txt.match(/Send Back By\s+([^\n]+)/i);if(sb)p.reqby=sb[1].trim();
    const sd=txt.match(/Send Back Date\s+([^\n]+)/i);if(sd){const d=new Date(sd[1].trim());if(!isNaN(d))p.datePasted=d.toISOString();}
    const co=txt.match(/Comments on Need Information\s+([\s\S]*?)(?=សូមអរគុណ|$)/i);if(co)p.reqtext=co[1].trim();
    const am=txt.match(/Total Claim Amount Submitted\s+[A-Z]+\s*([\d,.]+)/i)||txt.match(/USD\s*([\d,.]+)/i);if(am)p.amount=am[1];
  }
  if(!p.claimid)p.claimid=genId();
  if(!p.reqtext||!p.customer){openModal(p);return;}
  commitQuery(p);
}

/* ══ MODAL ══ */
function openModal(p){
  PENDING=p;
  const fields=[{id:'cid',val:p.claimid},{id:'ins',val:p.insurer},{id:'ico',val:p.inscomp},{id:'cus',val:p.customer,req:true},{id:'rby',val:p.reqby},{id:'acd',val:p.accdate||''},{id:'amt',val:p.amount},{id:'rtx',val:p.reqtext,req:true}];
  fields.forEach(f=>{
    const inp=document.getElementById('mf-'+f.id);if(!inp)return;
    inp.value=f.val||'';inp.classList.remove('inwarn');
    if(f.req){const tag=document.getElementById('mt-'+f.id);if(!tag)return;const det=(f.val||'').trim()!=='';tag.textContent=det?'Detected':'Required';tag.className=det?'ftag ftag-k':'ftag ftag-r';if(!det)inp.classList.add('inwarn');}
  });
  document.getElementById('modal').classList.add('open');
  const first=['cus','rtx'].find(id=>!document.getElementById('mf-'+id).value.trim());
  if(first)setTimeout(()=>document.getElementById('mf-'+first).focus(),320);
}
function closeModal(){document.getElementById('modal').classList.remove('open');PENDING=null;}
function submitModal(){
  const cid=document.getElementById('mf-cid').value.trim().replace(/^#/,'')||genId();
  const ins=document.getElementById('mf-ins').value.trim(),ico=document.getElementById('mf-ico').value.trim();
  const cus=document.getElementById('mf-cus').value.trim(),rby=document.getElementById('mf-rby').value.trim();
  const acd=document.getElementById('mf-acd').value,amt=document.getElementById('mf-amt').value.trim();
  const rtx=document.getElementById('mf-rtx').value.trim();
  if(!cus){markWarn('mf-cus','Claimant name is required');return;}
  if(!rtx){markWarn('mf-rtx','Request details are required');return;}
  closeModal();
  commitQuery({...(PENDING||{}),claimid:cid,insurer:ins,inscomp:ico,customer:cus,reqby:rby,accdate:acd,amount:amt,reqtext:rtx});
}
function markWarn(id,msg){const el=document.getElementById(id);el.classList.add('inwarn');el.focus();toast(msg,'err');el.addEventListener('input',()=>el.classList.remove('inwarn'),{once:true});}

/* ══ COMMIT ══ */
function firstStatus(){const s=DB.statuses[0];return s?(typeof s==='object'?s.name:s):'Pending Support Docs';}
function commitQuery(p){
  const cid=(p.claimid||'').replace(/^#/,'')||genId();
  const reqObj={datePasted:p.datePasted||new Date().toISOString(),requestedBy:p.reqby||'',text:p.reqtext||''};
  let c=DB.claims.find(x=>x.id===cid||getRem(x.remark).displayId===cid);
  if(c){
    c.requests.push(reqObj);c.dateModified=new Date().toISOString();
    if(c.status==='Complete')c.status=firstStatus();
    let r=getRem(c.remark);
    if(p.insurer)r.insurer=p.insurer;if(p.inscomp)r.inscomp=p.inscomp;
    if(p.amount)r.claimAmount=p.amount;if(p.accdate)r.accidentDate=p.accdate;
    c.remark=JSON.stringify(r);
  } else {
    const r={handler:localStorage.getItem('qt_user')||'Admin',text:'',phone:'',personalId:'',insurer:p.insurer||'',inscomp:p.inscomp||'',claimAmount:p.amount||'',accidentDate:p.accdate||'',displayId:cid,files:[]};
    c={id:cid,customer:p.customer||'Unknown',requests:[reqObj],status:firstStatus(),remark:JSON.stringify(r),dateIn:new Date().toISOString(),dateModified:new Date().toISOString(),trashDate:''};
    DB.claims.push(c);
  }
  document.getElementById('email-input').value='';
  closeDrawer();TAB='active';
  document.getElementById('tab-active').classList.add('on');
  document.getElementById('tab-trash').classList.remove('on');
  document.getElementById('nq-btn').style.display='';
  persist(c);toast('Query added','ok');
}

/* ══ MANUAL ══ */
function saveManual(){
  const cus=document.getElementById('m-cus').value.trim(),rtx=document.getElementById('m-rtx').value.trim();
  if(!cus){toast('Claimant name required','err');return;}
  if(!rtx){toast('Request details required','err');return;}
  const p={claimid:document.getElementById('m-cid').value.trim(),insurer:document.getElementById('m-ins').value.trim(),inscomp:document.getElementById('m-ico').value.trim(),customer:cus,reqby:document.getElementById('m-rby').value.trim(),accdate:document.getElementById('m-acd').value,amount:document.getElementById('m-amt').value.trim(),reqtext:rtx};
  ['m-cid','m-ins','m-ico','m-cus','m-rby','m-acd','m-amt','m-rtx'].forEach(id=>document.getElementById(id).value='');
  setNQMode('paste');commitQuery(p);
}

/* ══ FILE ATTACHMENTS ══ */
// Files are stored as [{name,path}] in remark.files
// "path" is the file:// URL obtained from the File object
// Opening: window.open(path) — works in same-origin browser from local HTML file
function attachFileToClaim(claimId){
  FILE_ATTACH_TARGET=claimId;
  document.getElementById('file-picker').value='';
  document.getElementById('file-picker').click();
}
document.getElementById('file-picker').addEventListener('change',function(){
  if(!FILE_ATTACH_TARGET||!this.files.length)return;
  const claimId=FILE_ATTACH_TARGET;
  FILE_ATTACH_TARGET=null;
  addFilesToClaim(claimId,[...this.files]);
});
function addFilesToClaim(claimId,files){
  const c=DB.claims.find(x=>x.id===claimId);if(!c)return;
  const r=getRem(c.remark);
  if(!r.files)r.files=[];
  let added=0;
  files.forEach(f=>{
    // Use webkitRelativePath or name; path via URL.createObjectURL isn't persistent.
    // Store the file path. On local file:// served pages, File.path gives full path (Chrome).
    const path=f.path||f.webkitRelativePath||f.name;
    // Avoid duplicate paths
    if(!r.files.find(x=>x.path===path&&x.name===f.name)){
      r.files.push({name:f.name,path:path});
      added++;
    }
  });
  c.remark=JSON.stringify(r);c.dateModified=new Date().toISOString();
  persist(c);
  toast(`${added} file${added!==1?'s':''} attached`,'ok');
}
function removeFile(claimId,idx){
  const c=DB.claims.find(x=>x.id===claimId);if(!c)return;
  const r=getRem(c.remark);
  if(!r.files)return;
  r.files.splice(idx,1);
  c.remark=JSON.stringify(r);c.dateModified=new Date().toISOString();
  persist(c);toast('File removed','ok');
}
function openFile(path,name){
  if(!path||path===name){
    toast('Full path not available — reattach file for direct open','err');return;
  }
  // Try file:// URL
  let url=path;
  if(!url.startsWith('file://')&&!url.startsWith('http')){
    // Windows path like C:\... or Unix /home/...
    url=path.startsWith('/')?'file://'+path:'file:///'+path.replace(/\\/g,'/');
  }
  window.open(url,'_blank');
}
function handleFileDrop(e,claimId){
  e.preventDefault();e.stopPropagation();
  const zone=e.currentTarget;
  zone.classList.remove('drag');
  if(e.dataTransfer.files.length)addFilesToClaim(claimId,[...e.dataTransfer.files]);
}

/* ══ RENDER ══ */
function renderClaims(){
  populateFilters();
  const list=document.getElementById('clist');
  const q=document.getElementById('search').value.toLowerCase();
  const srt=document.getElementById('sort').value;
  const fic=document.getElementById('flt-inscomp').value;
  const fir=document.getElementById('flt-insurer').value;

  let items=DB.claims.filter(c=>{
    const r=getRem(c.remark);
    const s=`${r.displayId||c.id} ${c.customer} ${r.insurer||''} ${r.inscomp||''} ${r.text||''} ${r.phone||''} ${r.personalId||''} ${r.handler||''}`.toLowerCase();
    const matchQ=s.includes(q);
    const matchTab=TAB==='trash'?c.status==='Complete':c.status!=='Complete';
    const matchComp=!fic||(r.inscomp||'')===fic;
    const matchIns=!fir||(r.insurer||'')===fir;
    return matchQ&&matchTab&&matchComp&&matchIns;
  });
  items.sort((a,b)=>{
    if(srt==='desc')return new Date(b.dateModified)-new Date(a.dateModified);
    if(srt==='asc')return new Date(a.dateModified)-new Date(b.dateModified);
    return(getRem(a.remark).displayId||a.id).localeCompare(getRem(b.remark).displayId||b.id);
  });
  if(!items.length){
    list.innerHTML=`<div class="empty"><div class="empty-ico"><svg width="19" height="19" viewBox="0 0 24 24" fill="none" stroke="var(--mu)" stroke-width="1.8"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg></div><div class="empty-t">No claims found</div><p style="font-size:12px">No ${TAB==='trash'?'completed':'active'} claims match your filters.</p></div>`;
    return;
  }
  const openIds=new Set([...document.querySelectorAll('.cc.open')].map(el=>el.id.replace('card-','')));
  list.innerHTML=items.map(c=>buildCard(c,openIds.has(c.id))).join('');
  // After render, auto-grow all textareas
  document.querySelectorAll('.ri-ta').forEach(ta=>autoGrow(ta));
}

/* ══ BUILD CARD ══ */
function buildCard(c,isOpen=false){
  const r=getRem(c.remark);
  const did=r.displayId||c.id;
  const handler=r.handler||'Unassigned';
  const days=daysSince(c.dateIn);
  const col=statusColor(c.status);
  const qcount=c.requests.length;
  const files=r.files||[];

  const statOpts=DB.statuses.map(s=>{const sn=typeof s==='object'?s.name:s;return`<option value="${esc(sn)}"${sn===c.status?' selected':''}>${esc(sn)}</option>`;}).join('');
  const amtPill=r.claimAmount?`<span class="pill pill-g">USD ${esc(r.claimAmount)}</span>`:'';
  const insPill=r.insurer?`<span class="pill pill-b pill-link" onclick="event.stopPropagation();filterByInsurer('${esc(r.insurer)}')" title="Filter by ${esc(r.insurer)}">${esc(r.insurer)}</span>`:'';
  const compPill=r.inscomp?`<span class="pill pill-link" onclick="event.stopPropagation();filterByCompany('${esc(r.inscomp)}')" title="Filter by ${esc(r.inscomp)}">${esc(r.inscomp)}</span>`:'';

  const qBtn=TAB==='active'
    ?`<button class="ib chk" title="Mark Complete" onclick="event.stopPropagation();ripple(this);setStatus('${c.id}','Complete')"><svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="20 6 9 17 4 12"/></svg></button>`
    :`<button class="ib rec" title="Recover" onclick="event.stopPropagation();ripple(this);recoverClaim('${c.id}')"><svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 102.13-9.36L1 10"/></svg></button>`;

  /* ── Request items (LEFT side) ── */
  const reqsHtml=c.requests.map((req,i)=>{
    const rd=new Date(req.datePasted).toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'});
    return`<div class="ri">
      <div class="ri-top">
        <div class="ri-meta">
          <input class="ri-by" type="text" value="${esc(req.requestedBy)}" placeholder="Requester (optional)" onchange="updateReqBy('${c.id}',${i},this.value)">
          <span class="ri-date">${rd}</span>
        </div>
        <button class="ib del" title="Delete request" onclick="deleteReq('${c.id}',${i})">
          <svg width="9" height="9" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      </div>
      <textarea class="ri-ta" oninput="autoGrow(this)" onchange="updateReqText('${c.id}',${i},this.value)">${esc(req.text)}</textarea>
    </div>`;
  }).join('');

  /* ── Files list (RIGHT side) ── */
  const filesHtml=files.map((f,i)=>`
    <div class="file-item">
      <div class="file-icon">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="var(--ac)" stroke-width="2" stroke-linecap="round"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
      </div>
      <div style="flex:1;min-width:0">
        <div class="file-name" title="${esc(f.name)}">${esc(f.name)}</div>
        <span class="file-path" title="${esc(f.path)}">${esc(f.path)}</span>
      </div>
      <button class="file-open" onclick="openFile('${esc(f.path)}','${esc(f.name)}')" title="Open file">Open</button>
      <button class="file-del" onclick="removeFile('${c.id}',${i})" title="Remove attachment">
        <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>`).join('');

  return`<div class="cc${isOpen?' open':''}" id="card-${c.id}">

  <!-- ── Summary Row ── -->
  <div class="ccrow" onclick="toggleCard('${c.id}')">
    <div class="ccL">
      <div class="cc-id">#${esc(did)}</div>
      ${r.insurer?`<div class="cc-ins">${esc(r.insurer)}</div>`:''}
    </div>
    <div class="ccM">
      <div class="chip">
        <span class="chip-l">Claimant</span>
        <span class="chip-v">${esc(c.customer)||'—'}</span>
      </div>
      ${r.inscomp?`<div class="chip"><span class="chip-l">Insured Co.</span><span class="chip-v">${esc(r.inscomp)}</span></div>`:''}
      <div class="chip">
        <span class="chip-l">Handler</span>
        <span class="chip-v">${esc(handler)}</span>
      </div>
      <div class="pills">
        <span class="pill">${qcount} quer${qcount===1?'y':'ies'}</span>
        <span class="pill">${days}d open</span>
        ${amtPill}${insPill}${compPill}
      </div>
    </div>
    <div class="ccR">
      ${qBtn}
      <button class="ib" title="Print / Save" onclick="event.stopPropagation();openPrintModal('${c.id}')">
        <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 01-2-2v-5a2 2 0 012-2h16a2 2 0 012 2v5a2 2 0 01-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>
      </button>
      <select class="spill" style="background-color:${col.bg};color:${col.tx}" onclick="event.stopPropagation()" onchange="setStatus('${c.id}',this.value)">${statOpts}</select>
      <div class="chevron"><svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="6 9 12 15 18 9"/></svg></div>
    </div>
  </div>

  <!-- ── Expand Panel ── -->
  <div class="ccp"><div class="ccp-inner"><div class="ccp-body">
    <div class="exp-layout">

      <!-- LEFT: Identity + Requests -->
      <div class="exp-main">

        <!-- Identity card — first thing you see -->
        <div class="id-card">
          <div class="id-card-icon">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
          </div>
          <div class="id-card-body">
            <div class="id-name">${esc(c.customer)||'Unknown Patient'}</div>
            <div style="font-size:12.5px;color:var(--tx2);margin-top:2px">
              ${r.inscomp?`<strong>${esc(r.inscomp)}</strong>`:'No company set'}
              ${r.insurer?` &nbsp;·&nbsp; <span style="color:var(--ac);font-weight:600">${esc(r.insurer)}</span>`:''}
            </div>
            <div class="id-meta">
              ${r.claimAmount?`<span class="id-tag"><svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/></svg>USD ${esc(r.claimAmount)}</span>`:''}
              ${r.accidentDate?`<span class="id-tag"><svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>${esc(r.accidentDate)}</span>`:''}
              ${r.phone?`<span class="id-tag"><svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6A19.79 19.79 0 012.12 4.18 2 2 0 014.11 2h3a2 2 0 012 1.72c.127.96.361 1.903.7 2.81a2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0122 16.92z"/></svg>${esc(r.phone)}</span>`:''}
              ${r.personalId?`<span class="id-tag"><svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="5" width="20" height="14" rx="2"/><line x1="2" y1="10" x2="22" y2="10"/></svg>${esc(r.personalId)}</span>`:''}
              <span class="id-tag"><svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>${esc(handler)}</span>
            </div>
          </div>
        </div>

        <!-- Document Requests -->
        <div class="psec">
          <div class="psec-hd">
            <div class="psec-ico"><svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="var(--ac)" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/></svg></div>
            <span class="psec-t">What They Are Requesting</span>
            <span class="psec-c">${qcount}</span>
          </div>
          <div class="psec-bd"><div class="rlist">${reqsHtml}</div></div>
        </div>

      </div><!-- /exp-main -->

      <!-- RIGHT: Claim details + contacts + files -->
      <div class="exp-side">

        <!-- Claim Info -->
        <div class="psec">
          <div class="psec-hd">
            <div class="psec-ico"><svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="var(--ac)" stroke-width="2"><rect x="2" y="2" width="20" height="20" rx="3"/><line x1="8" y1="8" x2="16" y2="8"/><line x1="8" y1="12" x2="14" y2="12"/></svg></div>
            <span class="psec-t">Claim Details</span>
          </div>
          <div class="psec-bd">
            <div class="fg2">
              <div style="grid-column:1/-1"><label class="fl">Claim Number</label><input type="text" value="${esc(did)}" onchange="updRem('${c.id}','displayId',this.value)"></div>
              <div><label class="fl">Insurer</label><input type="text" value="${esc(r.insurer||'')}" placeholder="e.g. AIA" onchange="updRem('${c.id}','insurer',this.value)"></div>
              <div><label class="fl">Claim Amount (USD)</label><input type="text" value="${esc(r.claimAmount||'')}" placeholder="0.00" onchange="updRem('${c.id}','claimAmount',this.value)"></div>
              <div style="grid-column:1/-1"><label class="fl">Insured Company</label><input type="text" value="${esc(r.inscomp||'')}" placeholder="Employer / group" onchange="updRem('${c.id}','inscomp',this.value)"></div>
              <div style="grid-column:1/-1"><label class="fl">Accident / Incident Date</label><input type="date" value="${esc(r.accidentDate||'')}" onchange="updRem('${c.id}','accidentDate',this.value)"></div>
              <div><label class="fl">Phone</label><input type="text" value="${esc(r.phone||'')}" placeholder="Contact" onchange="updRem('${c.id}','phone',this.value)"></div>
              <div><label class="fl">Personal ID</label><input type="text" value="${esc(r.personalId||'')}" placeholder="NID" onchange="updRem('${c.id}','personalId',this.value)"></div>
              <div><label class="fl">Claimant — Patient</label><input type="text" value="${esc(c.customer)}" placeholder="Patient name" onchange="updCustomer('${c.id}',this.value)"></div>
              <div><label class="fl">Handler</label><input type="text" value="${esc(handler)}" placeholder="Assign handler" onchange="updRem('${c.id}','handler',this.value)"></div>
              <div style="grid-column:1/-1"><label class="fl">Internal Remark</label><input type="text" value="${esc(r.text||'')}" placeholder="Notes" onchange="updRem('${c.id}','text',this.value)"></div>
            </div>
          </div>
        </div>

        <!-- File Attachments -->
        <div class="psec">
          <div class="psec-hd">
            <div class="psec-ico"><svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="var(--ac)" stroke-width="2"><path d="M21.44 11.05l-9.19 9.19a6 6 0 01-8.49-8.49l9.19-9.19a4 4 0 015.66 5.66l-9.2 9.19a2 2 0 01-2.83-2.83l8.49-8.48"/></svg></div>
            <span class="psec-t">Attached Files</span>
            <span class="psec-c">${files.length}</span>
            <div class="psec-acts">
              <button class="btn btn-g btn-sm" onclick="attachFileToClaim('${c.id}')">
                <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                Attach
              </button>
            </div>
          </div>
          <div class="psec-bd">
            <div class="file-drop-zone" id="fdz-${c.id}"
              ondragover="event.preventDefault();this.classList.add('drag')"
              ondragleave="this.classList.remove('drag')"
              ondrop="handleFileDrop(event,'${c.id}')"
              onclick="attachFileToClaim('${c.id}')">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--mu)" stroke-width="1.8"><path d="M21.44 11.05l-9.19 9.19a6 6 0 01-8.49-8.49l9.19-9.19a4 4 0 015.66 5.66l-9.2 9.19a2 2 0 01-2.83-2.83l8.49-8.48"/></svg>
              <p>Click or drag files here</p>
              <span>File path will be stored — not the file itself</span>
            </div>
            ${files.length?`<div class="file-list">${filesHtml}</div><p class="no-open-note">Files open from your local drive. If "Open" doesn't work, try running this app from a <code>file://</code> address.</p>`:''}
          </div>
        </div>

      </div><!-- /exp-side -->

    </div><!-- /exp-layout -->
  </div></div></div>
</div>`;
}

/* ══ TOGGLE ══ */
function toggleCard(id){
  const card=document.getElementById('card-'+id);
  const opening=!card.classList.contains('open');
  card.classList.toggle('open');
  if(opening){
    setTimeout(()=>{
      document.querySelectorAll(`#card-${id} .ri-ta`).forEach(ta=>autoGrow(ta));
      const y=card.getBoundingClientRect().top+window.scrollY-20;
      window.scrollTo({top:y,behavior:'smooth'});
    },300);
  }
}

/* ══ AUTO-GROW textarea ══ */
function autoGrow(el){
  el.style.height='auto';
  el.style.height=el.scrollHeight+'px';
}

/* ══ FILTER HELPERS ══ */
function filterByInsurer(v){document.getElementById('flt-insurer').value=v;renderClaims();}
function filterByCompany(v){document.getElementById('flt-inscomp').value=v;renderClaims();}

/* ══ UPDATES ══ */
function getRem(s){try{return JSON.parse(s||'{}');}catch{return{text:s||'',phone:'',personalId:'',handler:'',displayId:'',insurer:'',inscomp:'',claimAmount:'',accidentDate:'',files:[]};}}
function updRem(id,field,val){const c=DB.claims.find(x=>x.id===id);const r=getRem(c.remark);r[field]=val;c.remark=JSON.stringify(r);c.dateModified=new Date().toISOString();persist(c);toast('Saved','ok');}
function updCustomer(id,val){const c=DB.claims.find(x=>x.id===id);c.customer=val;c.dateModified=new Date().toISOString();persist(c);toast('Saved','ok');}
function updateReqText(id,i,val){const c=DB.claims.find(x=>x.id===id);c.requests[i].text=val;c.dateModified=new Date().toISOString();persist(c);toast('Saved','ok');}
function updateReqBy(id,i,val){const c=DB.claims.find(x=>x.id===id);c.requests[i].requestedBy=val;c.dateModified=new Date().toISOString();persist(c);toast('Saved','ok');}
function deleteReq(id,i){const c=DB.claims.find(x=>x.id===id);if(c.requests.length<=1){toast('Cannot delete the only request','err');return;}c.requests.splice(i,1);c.dateModified=new Date().toISOString();persist(c);toast('Request deleted','ok');}

/* ══ STATUS ══ */
function setStatus(id,val){
  const c=DB.claims.find(x=>x.id===id);
  c.status=val;c.dateModified=new Date().toISOString();
  c.trashDate=val==='Complete'?new Date().toISOString():'';
  persist(c);if(TAB==='active'&&val==='Complete')renderClaims();toast('Status updated','ok');
}
function recoverClaim(id){setStatus(id,firstStatus());setTimeout(()=>renderClaims(),80);}
function statusColor(name){
  const cs=DB.statuses.find(s=>typeof s==='object'&&s.name===name);
  if(cs&&cs.bg&&cs.txt)return{bg:cs.bg,tx:cs.txt};
  const n=(name||'').toLowerCase();
  if(n.includes('pending')||n.includes('awaiting'))return{bg:'var(--spb)',tx:'var(--spt)'};
  if(n.includes('process'))return{bg:'var(--scb)',tx:'var(--sct)'};
  if(n.includes('complete'))return{bg:'var(--skb)',tx:'var(--skt)'};
  return{bg:'var(--sdb)',tx:'var(--sdt)'};
}

/* ══ EXPORT ══ */
function exportCSV(){
  const maxQ=DB.claims.reduce((m,c)=>Math.max(m,c.requests.length),0);
  const hdr=['Claim Number','Insurer','Insured Company','Claimant','Handled By','Status','Claim Amount','Accident Date','Open Days','Phone','Personal ID','Remark','Query Count'];
  for(let i=1;i<=maxQ;i++)hdr.push(`Request ${i} Date`,`Request ${i} By`,`Request ${i} Details`);
  let csv="\uFEFF"+hdr.map(h=>`"${h}"`).join(',')+'\r\n';
  DB.claims.forEach(c=>{
    const r=getRem(c.remark);const q=s=>'"'+(s||'').replace(/"/g,'""')+'"';
    let row=[r.displayId||c.id,q(r.insurer),q(r.inscomp),q(c.customer),q(r.handler),q(c.status),q(r.claimAmount),q(r.accidentDate),daysSince(c.dateIn),q(r.phone),q(r.personalId),q(r.text),c.requests.length];
    for(let i=0;i<maxQ;i++){const req=c.requests[i];if(req){row.push(q(new Date(req.datePasted).toLocaleDateString('en-GB')),q(req.requestedBy||''),q(req.text||''));}else{row.push('','','');}}
    csv+=row.join(',')+'\r\n';
  });
  const a=document.createElement('a');a.href='data:text/csv;charset=utf-8,'+encodeURI(csv);a.download=`QueryTracker_${new Date().toISOString().split('T')[0]}.csv`;document.body.appendChild(a);a.click();a.remove();toast('Export complete','ok');
}

/* ══ UTILS ══ */
function esc(s){return(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function daysSince(d){return Math.floor(Math.abs(new Date()-new Date(d))/86400000);}
function toast(msg,type='info'){
  const dock=document.getElementById('tdock');const t=document.createElement('div');t.className='toast';
  const dot=document.createElement('div');dot.className='tdot';dot.style.background=type==='err'?'#ef4444':type==='ok'?'#10b981':'#3b82f6';
  t.appendChild(dot);t.appendChild(document.createTextNode(msg));dock.appendChild(t);
  requestAnimationFrame(()=>requestAnimationFrame(()=>t.classList.add('in')));
  setTimeout(()=>{t.classList.remove('in');setTimeout(()=>t.remove(),260);},2700);
}
function ripple(btn){btn.classList.remove('rpling');void btn.offsetWidth;btn.classList.add('rpling');setTimeout(()=>btn.classList.remove('rpling'),500);}

/* ══ DRAG & DROP (email) ══ */
const dz=document.getElementById('drop-zone');
dz.addEventListener('dragover',e=>{e.preventDefault();dz.classList.add('drag');});
dz.addEventListener('dragleave',()=>dz.classList.remove('drag'));
dz.addEventListener('drop',e=>{e.preventDefault();dz.classList.remove('drag');const d=e.dataTransfer.getData('text');if(d){document.getElementById('email-input').value=d;processInput();}});

/* Backdrops */
document.getElementById('modal').addEventListener('click',function(e){if(e.target===this)closeModal();});
document.getElementById('print-modal').addEventListener('click',function(e){if(e.target===this)closePrintModal();});
</script>
</body>
</html>

